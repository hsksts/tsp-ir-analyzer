<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSP IR Analyzer (Web Audio, OATSP) + Live Spectrum</title>
  <style>
    :root { --fg:#111; --bg:#fafafa; --muted:#666; --card:#fff; --border:#e5e5e5; --accent:#0a7; }
    * { box-sizing: border-box; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,sans-serif; color:var(--fg); background:var(--bg); }
    h1 { margin:0 0 12px; font-size:1.3rem; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.04); margin-bottom:16px; }
    .row { display:grid; gap:12px; }
    .controls { display:flex; flex-wrap:wrap; gap:12px; align-items:end; }
    .controls label { display:flex; flex-direction:column; font-size:.9rem; color:var(--muted); }
    .btn { padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .btn.primary { background:var(--accent); color:#fff; border-color:transparent; }
    .grid2 { display:grid; grid-template-columns: repeat(2, minmax(200px,1fr)); gap:12px; }
    canvas { width:100%; height:220px; background:#111; border-radius:12px; }
    .small { font-size:.85rem; color:var(--muted); }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; align-items:center; }
    .downloads a { margin-right:12px; }
    input[type="number"], input[type="range"], select, input[readonly] { font:inherit; }
    input[readonly] { background:#f4f4f4; border:1px solid var(--border); padding:6px 8px; border-radius:8px; color:#444; }
    .label-white { color:#fff; margin-bottom:6px; }
    .warn { color:#b00; font-size:.85rem; }
    .inline { display:flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <h1>ğŸ“ˆ Timeâ€‘Stretched Pulse (OATSP) IR Analyzer + Live Spectrum</h1>

  <div class="card row">
    <div class="controls">
      <label>Jisuï¼ˆä¿¡å·æ¬¡æ•°, N=2^Jisuï¼‰
        <input id="jisu" type="number" min="10" max="22" step="1" value="18">
      </label>
      <label>æŒ¯å¹… A
        <input id="ampA" type="number" min="0.1" step="0.1" value="4">
      </label>
      <label>ãƒ†ã‚¤ãƒ«ç„¡éŸ³ï¼ˆsï¼‰
        <input id="silenceTail" type="number" min="0" step="0.5" value="2">
      </label>
      <label>å†ç”Ÿãƒ¬ãƒ™ãƒ«ï¼ˆ0â€“1ï¼‰
        <input id="playGain" type="range" min="0" max="1" step="0.01" value="0.8">
      </label>
      <label>å†ç”Ÿä¿¡å·
        <select id="playSig">
          <option value="down" selected>DOWN (excitation)</option>
          <option value="up">UP (inverse)</option>
        </select>
      </label>
      <label>ãƒã‚¤ã‚¯ï¼ˆå…¥åŠ›ï¼‰
        <select id="micSelect"></select>
      </label>
      <label>ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ï¼ˆå‡ºåŠ›ï¼‰
        <select id="spkSelect"></select>
      </label>
      <span id="sinkNote" class="small"></span>
      <label>ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆï¼ˆè¡¨ç¤ºï¼‰
        <input id="fsDisp" type="text" readonly>
      </label>
      <label class="inline">
        <input id="normDisplay" type="checkbox" checked>
        è¡¨ç¤ºã‚’åŸºæº–åŒ–ï¼ˆRecording/IR/Selfâ€‘Testï¼‰
      </label>
    </div>
    <div class="controls">
      <button id="genBtn" class="btn">ğŸ›ï¸ 1) TSPç”Ÿæˆï¼ˆdownTSP / upTSPï¼‰</button>
      <button id="playRecBtn" class="btn primary">â–¶ï¸ 2) å†ç”Ÿï¼†éŒ²éŸ³</button>
      <button id="analyzeBtn" class="btn">ğŸ§® 3) è§£æï¼ˆIR / TFï¼‰</button>
      <button id="monitorBtn" class="btn">ğŸ” Mic Monitor: OFF</button>
      <button id="selfTestBtn" class="btn">ğŸ§ª Selfâ€‘Test (DOWN âŠ› UP)</button>
    </div>
    <div class="small">
      OATSPï¼ˆTSPï¼‰ã‚’ <b>å‘¨æ³¢æ•°é ˜åŸŸã§æ§‹æˆ â†’ IFFT â†’ å††çŠ¶ã‚·ãƒ•ãƒˆ</b>ã€‚è§£æã¯ <b>FFT é€†ç•³ã¿è¾¼ã¿</b>ã€‚<br>
      ã‚¹ãƒšã‚¯ãƒˆãƒ«ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ã¯<b>é¸æŠã—ãŸå…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹ã®ã¿</b>ã‚’ç›£è¦–ã€‚è¡¨ç¤ºã¯ä»»æ„ã§åŸºæº–åŒ–ã§ãã¾ã™ã€‚
    </div>
  </div>

  <div class="card row">
    <div class="kv">
      <div>Excitationï¼ˆdownTSPï¼‰:</div><div id="excitationInfo">-</div>
      <div>Inverseï¼ˆupTSPï¼‰:</div><div id="inverseInfo">-</div>
      <div>Recording:</div><div id="recordingInfo">-</div>
      <div>Alignment lag (samples):</div><div id="lagInfo">-</div>
      <div>Sample Rate:</div><div id="srInfo">-</div>
    </div>
    <div class="downloads" id="dlArea"></div>
    <div id="httpsWarn" class="warn"></div>
  </div>

  <div class="card row">
    <div class="label-white">Mic Spectrum (Live, logâ€‘f)</div>
    <canvas id="micSpectrum" width="900" height="220" aria-label="Mic Spectrum Analyzer"></canvas>
  </div>

  <div class="card row grid2">
    <div>
      <div class="label-white">Time Domain (preview / Recording / IR)</div>
      <canvas id="irCanvas" width="900" height="220" aria-label="Impulse Response"></canvas>
    </div>
    <div>
      <div class="label-white">Transfer Function |H(f)| (dB)</div>
      <canvas id="magCanvas" width="900" height="220" aria-label="Magnitude Response"></canvas>
    </div>
  </div>

  <!-- å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹åˆ‡æ›¿ç”¨ï¼šWebAudioâ†’MediaStreamDestinationâ†’ã“ã®audioã¸ -->
  <audio id="sinkAudio" autoplay playsinline></audio>

  <script src="recorder-worklet.js"></script>
  <script src="app.js"></script>
</body>
</html>
